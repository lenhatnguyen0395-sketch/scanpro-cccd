<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScanPro CCCD (Bản nhúng)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        :root {
            --color-primary-400: 251 191 36;
            --color-primary-500: 245 158 11;
        }
        body {
            font-family: 'Poppins', sans-serif;
            scroll-behavior: smooth;
            @apply transition-colors duration-300;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        html:not(.dark) .loader {
             border-color: rgba(0,0,0,0.1);
             border-top-color: rgb(var(--color-primary-500));
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { @apply bg-gray-900; }
        .custom-scrollbar::-webkit-scrollbar-track { @apply bg-gray-100; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { @apply bg-gray-400 dark:bg-gray-600; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { @apply bg-gray-500 dark:bg-gray-500; }
        #reader_wrapper { border-radius: 1rem; }
        #reader__dashboard_section_csr > div > button { display: none !important; }
        #reader { position: relative; border-radius: 1rem; overflow: hidden; background-color: #000; }
        #reader::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px; box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.7); border-radius: 1rem; border: 2px solid rgba(var(--color-primary-400), 0.7); z-index: 10; }
        #reader::after { content: ''; position: absolute; left: 50%; transform: translateX(-50%); width: 240px; height: 3px; background: linear-gradient(90deg, transparent, rgb(var(--color-primary-500)), transparent); box-shadow: 0 0 5px rgb(var(--color-primary-500)), 0 0 10px rgb(var(--color-primary-500)); border-radius: 2px; animation: scan-anim 2.5s ease-in-out infinite; z-index: 11; }
        @keyframes scan-anim { 0% { top: calc(50% - 120px); } 50% { top: calc(50% + 120px); } 100% { top: calc(50% - 120px); } }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-backdrop.hidden { opacity: 0; pointer-events: none; }
        .modal-backdrop.hidden .modal-content { transform: scale(0.95) translateY(10px); opacity: 0; }
        .modal-backdrop:not(.hidden) { opacity: 1; pointer-events: auto; }
        .gradient-text { @apply bg-gradient-to-r from-[rgb(var(--color-primary-400))] to-[rgb(var(--color-primary-500))] bg-clip-text text-transparent; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .data-item { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .chevron-icon { transform: rotate(180deg); }
    </style>
</head>

<body class="bg-slate-50 dark:bg-gray-900 text-gray-800 dark:text-gray-300">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl relative">
        <div class="absolute top-4 right-4 md:top-8 md:right-8 z-20 flex flex-col items-end gap-3">
            <div class="flex items-center gap-3">
                 <button id="theme-toggle" class="h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-[rgb(var(--color-primary-400))] hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300 flex items-center justify-center shadow-lg">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </div>

        <details class="mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 open:ring-2 open:ring-[rgb(var(--color-primary-500))] transition">
            <summary class="font-semibold text-lg p-4 cursor-pointer list-none flex items-center justify-between">
                <div class="flex items-center space-x-2 text-gray-800 dark:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[rgb(var(--color-primary-500))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7s0 0 0 0" /></svg>
                    <span>Quản lý dữ liệu tra cứu</span>
                </div>
                <svg class="chevron-icon w-5 h-5 transition-transform duration-300 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
            </summary>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">1. Dữ liệu chuẩn hóa (DSdiachi)</p>
                        <div class="flex space-x-2">
                            <label for="import-diachi" class="flex-1 text-center cursor-pointer bg-blue-500 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-600 transition">Nhập tệp</label>
                            <input type="file" id="import-diachi" class="hidden" accept=".csv">
                            <button id="export-diachi" class="flex-1 bg-gray-200 dark:bg-gray-600 px-3 py-2 rounded-md text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition">Tải mẫu</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">2. Dữ liệu sáp nhập (DSdiachisatnhap)</p>
                        <div class="flex space-x-2">
                             <label for="import-satnhap" class="flex-1 text-center cursor-pointer bg-blue-500 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-600 transition">Nhập tệp</label>
                            <input type="file" id="import-satnhap" class="hidden" accept=".csv">
                            <button id="export-satnhap" class="flex-1 bg-gray-200 dark:bg-gray-600 px-3 py-2 rounded-md text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition">Tải mẫu</button>
                        </div>
                    </div>
                </div>
                <p id="data-import-status" class="text-xs text-center text-green-600 dark:text-green-400 mt-3 h-4"></p>
            </div>
        </details>
        
        <header class="mb-8 text-center flex flex-col items-center">
            <div class="flex items-center space-x-4">
                <svg class="h-16 w-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs><linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#FBBF24;stop-opacity:1" /><stop offset="100%" style="stop-color:#F59E0B;stop-opacity:1" /></linearGradient></defs>
                    <path d="M4 7C4 5.89543 4.89543 5 6 5H18C19.1046 5 20 5.89543 20 7V17C20 18.1046 19.1046 19 18 19H6C4.89543 19 4 18.1046 4 17V7Z" stroke="url(#logoGradient)" stroke-width="2"/><path d="M8 9H11" stroke="currentColor" class="text-gray-600 dark:text-white" stroke-width="1.5" stroke-linecap="round"/><path d="M8 12H16" stroke="currentColor" class="text-gray-600 dark:text-white" stroke-width="1.5" stroke-linecap="round"/><path d="M8 15H16" stroke="currentColor" class="text-gray-600 dark:text-white" stroke-width="1.5" stroke-linecap="round"/><path d="M2 12H22" stroke="url(#logoGradient)" stroke-width="1" stroke-linecap="round" stroke-dasharray="2 4"/>
                </svg>
                <h1 class="text-4xl md:text-5xl font-extrabold gradient-text">ScanPro CCCD</h1>
            </div>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Quét, lưu trữ và quản lý thông tin một cách nhanh chóng và hiện đại.</p>
            <div id="user-info" class="mt-4 text-sm text-gray-500">Đang khởi tạo...</div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 space-y-6 self-start lg:sticky top-8">
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white flex items-center space-x-2"><span>📝</span><span>Nhập liệu</span></h2>
                    <button id="scan-camera-btn" class="w-full bg-[rgb(var(--color-primary-500))] text-white font-bold py-3 px-4 rounded-lg hover:bg-[rgb(var(--color-primary-400))] transition duration-300 mb-4 flex items-center justify-center space-x-2 shadow-lg"><span>📸</span> <span>Quét bằng Camera</span></button>
                    <div id="scanner-container" class="hidden mb-4 relative">
                        <div id="reader" class="w-full aspect-square"></div>
                        <p class="text-xs text-center text-gray-500 dark:text-gray-400 mt-2">Đưa mã QR vào trong khung để quét.</p>
                        <button id="stop-scan-btn" class="mt-2 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Dừng Quét</button>
                    </div>
                    <label for="qr-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Hoặc dán chuỗi QR code:</label>
                    <textarea id="qr-input" rows="4" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-[rgb(var(--color-primary-500))] focus:border-[rgb(var(--color-primary-500))] transition"></textarea>
                    <div class="flex space-x-2 mt-3">
                        <button id="analyze-btn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Phân tích</button>
                        <button id="clear-form-btn" class="flex-1 bg-gray-500 dark:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-500 transition">Xóa Form</button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white flex items-center space-x-2"><span>📋</span><span>Thông tin đã trích xuất</span></h2>
                    <div class="space-y-3">
                        <input type="text" id="so-cccd" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Số Căn Cước Công Dân" readonly>
                        <input type="text" id="so-cmnd" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Số CMND (cũ nếu có)" readonly>
                        <input type="text" id="ho-ten" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Họ và Tên" readonly>
                        <input type="text" id="ngay-sinh" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Ngày Sinh" readonly>
                        <input type="text" id="gioi-tinh" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Giới Tính" readonly>
                        <input type="text" id="dia-chi-cu" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Địa chỉ đầy đủ (cũ)" readonly>
                        <input type="text" id="ngay-cap" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Ngày Cấp" readonly>
                        <input type="text" id="dia-chi-chi-tiet" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Số nhà, đường, thôn..." readonly>
                        <input type="text" id="phuong-xa-cu" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Phường / Xã (cũ)" readonly>
                        <input type="text" id="quan-huyen-cu" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Quận / Huyện (cũ)" readonly>
                        <input type="text" id="tinh-thanh-cu" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Tỉnh / Thành phố (cũ)" readonly>
                        <input type="text" id="phuong-xa-moi" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Phường / Xã (mới)">
                        <input type="text" id="tinh-thanh-moi" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Tỉnh / Thành phố (mới)">
                        <input type="text" id="dia-chi-day-du-moi" class="w-full p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg" placeholder="Địa chỉ đầy đủ (mới)" readonly>
                    </div>
                    <button id="save-btn" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-500 transition duration-300 flex items-center justify-center space-x-2 shadow-lg"><span id="save-btn-text">💾 Lưu Thông Tin</span><div id="save-loader" class="hidden"></div></button>
                    <div id="status-message" class="mt-3 text-center text-sm h-5"></div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-4 flex items-center space-x-4"><div class="bg-blue-500/10 dark:bg-blue-500/20 p-3 rounded-full"><span class="text-2xl">🗂️</span></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">Tổng số</p><p id="total-count" class="text-2xl font-bold text-gray-900 dark:text-white">0</p></div></div>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-4 flex items-center space-x-4"><div class="bg-green-500/10 dark:bg-green-500/20 p-3 rounded-full"><span class="text-2xl">🙋‍♂️</span></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">Nam</p><p id="male-count" class="text-2xl font-bold text-gray-900 dark:text-white">0</p></div></div>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-4 flex items-center space-x-4"><div class="bg-pink-500/10 dark:bg-pink-500/20 p-3 rounded-full"><span class="text-2xl">🙋‍♀️</span></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">Nữ</p><p id="female-count" class="text-2xl font-bold text-gray-900 dark:text-white">0</p></div></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col" style="height: calc(100vh - 24rem); min-height: 500px;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Dữ liệu đã lưu</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center">
                        <div class="relative flex-grow w-full"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">🔍</span><input type="text" id="search-input" placeholder="Tìm kiếm..." class="w-full p-2 pl-10 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-[rgb(var(--color-primary-500))] focus:border-[rgb(var(--color-primary-500))] transition"></div>
                        <div class="flex items-center space-x-2 w-full sm:w-auto">
                             <div class="flex items-center space-x-2"><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-[rgb(var(--color-primary-500))] bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-[rgb(var(--color-primary-500))]"><label for="select-all-checkbox" class="text-sm font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap">Chọn tất cả</label></div>
                            <select id="sort-select" class="p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-[rgb(var(--color-primary-500))] focus:border-[rgb(var(--color-primary-500))] transition"><option value="newest">Mới nhất</option><option value="oldest">Cũ nhất</option><option value="name_asc">Tên (A-Z)</option><option value="name_desc">Tên (Z-A)</option></select>
                            <div id="view-mode-toggle" class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                                <button data-view="grid" class="p-1.5 rounded-md" title="Dạng Lưới"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg></button>
                                <button data-view="list" class="p-1.5 rounded-md" title="Dạng Danh sách"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg></button>
                            </div>
                        </div>
                    </div>
                    <div id="bulk-action-toolbar" class="flex items-center justify-between bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg mb-4 hidden"><span id="selection-count" class="text-sm font-medium"></span><button id="delete-selected-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition text-sm flex items-center space-x-1"><span>🗑️</span> <span>Xóa mục đã chọn</span></button></div>
                    <div id="data-status" class="text-sm text-gray-500 dark:text-gray-400 mb-2 flex-shrink-0">Đang tải dữ liệu...</div>
                    <div id="data-container" class="flex-grow custom-scrollbar pr-2 overflow-y-auto"><div id="loading-spinner-cards" class="col-span-full text-center py-8"><div class="loader mx-auto !w-12 !h-12 !border-4"></div><p class="text-gray-500 dark:text-gray-400 mt-4">Đang tải dữ liệu...</p></div></div>
                    <div id="pagination-controls" class="flex-shrink-0 pt-4 flex items-center justify-between text-sm"></div>
                     <button id="delete-all-btn" class="flex-shrink-0 mt-4 w-full bg-red-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-900 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"><span>🔥</span> <span>Xóa Tất Cả Dữ Liệu</span></button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden modal-backdrop"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6 modal-content border border-gray-200 dark:border-gray-700 flex flex-col" style="max-height: 90vh;"><h3 class="text-2xl font-semibold mb-6 text-gray-900 dark:text-white flex-shrink-0">✏️ Chỉnh sửa thông tin</h3><form id="edit-form" class="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-grow"><input type="hidden" id="edit-doc-id"><input type="text" id="edit-ho-ten" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Họ và Tên"><input type="text" id="edit-so-cccd" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Số CCCD"><input type="text" id="edit-ngay-sinh" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Ngày Sinh (DD/MM/YYYY)"><select id="edit-gioi-tinh" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"><option>Nam</option><option>Nữ</option><option>Khác</option></select><input type="text" id="edit-dia-chi-cu" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Địa chỉ đầy đủ (cũ)"><input type="text" id="edit-tinh-thanh-cu" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Tỉnh / Thành phố (cũ)"><input type="text" id="edit-quan-huyen-cu" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Quận / Huyện (cũ)"><input type="text" id="edit-phuong-xa-cu" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Phường / Xã (cũ)"><input type="text" id="edit-dia-chi-chi-tiet" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Số nhà, đường, thôn..."><input type="text" id="edit-phuong-xa-moi" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Phường / Xã (mới)"><input type="text" id="edit-tinh-thanh-moi" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Tỉnh / Thành phố (mới)"><input type="text" id="edit-dia-chi-day-du-moi" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Địa chỉ đầy đủ (mới)"><input type="text" id="edit-ngay-cap" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Ngày Cấp (DD/MM/YYYY)"></form><div class="flex justify-end space-x-3 pt-4 flex-shrink-0"><button type="button" id="cancel-edit-btn" class="bg-gray-500 dark:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-500 transition">Hủy</button><button type="submit" form="edit-form" class="bg-[rgb(var(--color-primary-500))] text-white font-bold py-2 px-4 rounded-lg hover:bg-[rgb(var(--color-primary-400))] transition">Lưu thay đổi</button></div></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden modal-backdrop"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 text-center modal-content border border-gray-200 dark:border-gray-700"><h3 class="text-xl font-semibold mt-4 mb-2 text-gray-900 dark:text-white">⚠️ Bạn có chắc chắn không?</h3><p id="delete-confirm-text" class="text-gray-500 dark:text-gray-400 mb-6"></p><div class="flex justify-center space-x-4"><button type="button" id="cancel-delete-btn" class="bg-gray-500 dark:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-500 transition">Hủy</button><button type="button" id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Xác nhận Xóa</button></div></div></div>
    <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden modal-backdrop"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6 modal-content border border-gray-200 dark:border-gray-700"><h3 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">✨ Tóm tắt hồ sơ bởi Gemini</h3><div id="summary-content" class="text-gray-600 dark:text-gray-300 min-h-[100px] flex items-center justify-center"><div class="loader mx-auto"></div></div><div class="flex justify-end space-x-3 pt-4"><button type="button" id="close-summary-btn" class="bg-gray-500 dark:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-500 transition">Đóng</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let embeddedStandardizeData = [], embeddedMappingData = { provinces: {}, wards: {} };
        
        // [FIXED] Cả 2 hàm bên dưới đã được viết lại để sửa lỗi logic
        function normalizeStr(s) {
          if (!s) return "";
          return s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\bhcm\b/g, "thanh pho ho chi minh").replace(/\bhn\b/g, "thanh pho ha noi").replace(/\b(tp\.?|tinh|thành phố|tỉnh)\b/g, " ").replace(/\b(q\.?|quận|h\.?|huyện)\b/g, " ").replace(/\b(p\.?|phường|x\.?|xã|tt\.?|thị trấn)\b/g, " ").replace(/[^a-z0-9\s]/g, " ").replace(/\s+/g, " ").trim();
        }

        // ==== START: CHẶN THAY THẾ CHO standardizeAddressLocal (ĐÃ FIX) ====
        function standardizeAddressLocal(payload) {
            const nWard = normalizeStr(payload.ward), nDistrict = normalizeStr(payload.district), nProvince = normalizeStr(payload.province);
            let bestMatch = null, bestScore = -1;
            for (const row of embeddedStandardizeData) {
                // DSdiachi.csv assumed columns: [0]=Province, [1]=MaTP, [2]=District, [3]=MaQH, [4]=Ward, ...
                const sheetProvince = String(row[0] || "").trim();
                const sheetDistrict = String(row[2] || "").trim();
                const sheetWard = String(row[4] || "").trim();
                const nSheetProvince = normalizeStr(sheetProvince), nSheetDistrict = normalizeStr(sheetDistrict), nSheetWard = normalizeStr(sheetWard);
                let currentScore = 0;
                
                // match province (strong)
                if (nProvince && nSheetProvince && (nSheetProvince.includes(nProvince) || nProvince.includes(nSheetProvince))) {
                    currentScore += 3;
                }
                // match district but ensure province agreement
                if (nDistrict && nSheetDistrict &&
                    (nSheetDistrict.includes(nDistrict) || nDistrict.includes(nSheetDistrict)) &&
                    (!nProvince || nSheetProvince.includes(nProvince))) {
                    currentScore += 3;
                }
                // match ward with district & province agreement
                if (nWard && nSheetWard &&
                    (nSheetWard.includes(nWard) || nWard.includes(nSheetWard)) &&
                    (!nDistrict || nSheetDistrict.includes(nDistrict)) &&
                    (!nProvince || nSheetProvince.includes(nProvince))) {
                    currentScore += 4;
                }

                if (currentScore > bestScore) {
                    bestScore = currentScore;
                    bestMatch = { standardizedProvince: sheetProvince, standardizedDistrict: sheetDistrict, standardizedWard: sheetWard };
                }
                if (bestScore === 10) break;
            }
            if (bestMatch) return bestMatch;
            return { standardizedProvince: payload.province, standardizedDistrict: payload.district, standardizedWard: payload.ward };
        }
        // ==== END: CHẶN THAY THẾ CHO standardizeAddressLocal (ĐÃ FIX) ====

        function findMappingLocal(standardized) {
            const nWard = normalizeStr(standardized.standardizedWard), nProvince = normalizeStr(standardized.standardizedProvince);
            let newWard = standardized.standardizedWard, newDistrict = standardized.standardizedDistrict, newProvince = standardized.standardizedProvince;
            
            const provinceMapKey = Object.keys(embeddedMappingData.provinces).find(k => k === nProvince);
            if(provinceMapKey) newProvince = embeddedMappingData.provinces[provinceMapKey];

            const wardMapKey = Object.keys(embeddedMappingData.wards).find(k => k === nWard);
            if (wardMapKey) {
                const candidates = embeddedMappingData.wards[wardMapKey] || [];
                const bestCand = candidates.find(c => normalizeStr(c.newProvince) === normalizeStr(newProvince)) || candidates[0];
                if (bestCand) {
                    newWard = bestCand.newWard;
                    newProvince = bestCand.newProvince;
                }
            }
            return { newWard, newDistrict, newProvince };
        }

        let firebaseConfig;
        try { firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); } catch (e) { console.error("Lỗi cấu hình Firebase:", e); }
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwoyBLp9D4AWYY1-iZfVCAAUEAYs4QupUYquks22sErubWSwy6qZIZLFJZicCe0GG98rg/exec';
        let currentUserId = null, html5QrCode = null, allData = [], selectedIds = [], docIdsToDelete = [], currentRenderedIds = [];
        let currentPage = 1, currentViewMode = 'grid';
        const ITEMS_PER_PAGE = 8;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const cccdCollectionRef = collection(db, `artifacts/${appId}/public/data/cccd_scans`);
        const qrInput = document.getElementById('qr-input'), analyzeBtn = document.getElementById('analyze-btn'), saveBtn = document.getElementById('save-btn'), clearFormBtn = document.getElementById('clear-form-btn'), statusMessage = document.getElementById('status-message'), saveLoader = document.getElementById('save-loader'), dataContainer = document.getElementById('data-container'), userInfo = document.getElementById('user-info'), dataStatus = document.getElementById('data-status'), scanCameraBtn = document.getElementById('scan-camera-btn'), scannerContainer = document.getElementById('scanner-container'), stopScanBtn = document.getElementById('stop-scan-btn'), searchInput = document.getElementById('search-input'), sortSelect = document.getElementById('sort-select'), editModal = document.getElementById('edit-modal'), editForm = document.getElementById('edit-form'), cancelEditBtn = document.getElementById('cancel-edit-btn'), editDocIdInput = document.getElementById('edit-doc-id'), deleteConfirmModal = document.getElementById('delete-confirm-modal'), cancelDeleteBtn = document.getElementById('cancel-delete-btn'), confirmDeleteBtn = document.getElementById('confirm-delete-btn'), deleteConfirmText = document.getElementById('delete-confirm-text'), selectAllCheckbox = document.getElementById('select-all-checkbox'), bulkActionToolbar = document.getElementById('bulk-action-toolbar'), selectionCount = document.getElementById('selection-count'), deleteSelectedBtn = document.getElementById('delete-selected-btn'), deleteAllBtn = document.getElementById('delete-all-btn'), loadingSpinnerCards = document.getElementById('loading-spinner-cards'), totalCountEl = document.getElementById('total-count'), maleCountEl = document.getElementById('male-count'), femaleCountEl = document.getElementById('female-count'), paginationControls = document.getElementById('pagination-controls'), summaryModal = document.getElementById('summary-modal'), summaryContent = document.getElementById('summary-content'), closeSummaryBtn = document.getElementById('close-summary-btn'), viewModeToggle = document.getElementById('view-mode-toggle');
        const formFields = { soCccd: document.getElementById('so-cccd'), soCmnd: document.getElementById('so-cmnd'), hoVaTen: document.getElementById('ho-ten'), ngaySinh: document.getElementById('ngay-sinh'), gioiTinh: document.getElementById('gioi-tinh'), diaChiCu: document.getElementById('dia-chi-cu'), ngayCap: document.getElementById('ngay-cap'), diaChiChiTiet: document.getElementById('dia-chi-chi-tiet'), phuongXaCu: document.getElementById('phuong-xa-cu'), quanHuyenCu: document.getElementById('quan-huyen-cu'), tinhThanhCu: document.getElementById('tinh-thanh-cu'), phuongXaMoi: document.getElementById('phuong-xa-moi'), tinhThanhMoi: document.getElementById('tinh-thanh-moi'), diaChiDayDuMoi: document.getElementById('dia-chi-day-du-moi') };
        const editFormFields = { soCccd: document.getElementById('edit-so-cccd'), hoVaTen: document.getElementById('edit-ho-ten'), ngaySinh: document.getElementById('edit-ngay-sinh'), gioiTinh: document.getElementById('edit-gioi-tinh'), diaChiCu: document.getElementById('edit-dia-chi-cu'), ngayCap: document.getElementById('edit-ngay-cap'), diaChiChiTiet: document.getElementById('edit-dia-chi-chi-tiet'), phuongXaCu: document.getElementById('edit-phuong-xa-cu'), quanHuyenCu: document.getElementById('edit-quan-huyen-cu'), tinhThanhCu: document.getElementById('edit-tinh-thanh-cu'), phuongXaMoi: document.getElementById('edit-phuong-xa-moi'), tinhThanhMoi: document.getElementById('edit-tinh-thanh-moi'), diaChiDayDuMoi: document.getElementById('edit-dia-chi-day-du-moi') };
        async function analyzeQRCode() { const qrData = qrInput.value.trim(); if (!qrData) { statusMessage.textContent = 'Vui lòng dán chuỗi QR code.'; return; } const parts = qrData.split('|'); if (parts.length < 6) { statusMessage.textContent = 'Định dạng chuỗi QR code không hợp lệ.'; return; } formFields.soCccd.value = parts[0] || ''; formFields.soCmnd.value = parts[1] || ''; formFields.hoVaTen.value = parts[2] || ''; formFields.ngaySinh.value = formatNgay(parts[3] || ''); formFields.gioiTinh.value = parts[4] || ''; const rawAddress = parts[5] || ''; formFields.diaChiCu.value = rawAddress; formFields.ngayCap.value = formatNgay(parts[6] || ''); if (!rawAddress) { statusMessage.textContent = 'Phân tích xong, không có thông tin địa chỉ.'; return; } statusMessage.textContent = 'Đang phân tích...'; const oldAddressComponents = parseVietnameseAddress(rawAddress); const standardizedResult = standardizeAddressLocal(oldAddressComponents); const newAddressComponents = findMappingLocal(standardizedResult); formFields.diaChiChiTiet.value = oldAddressComponents.street_house; formFields.phuongXaCu.value = standardizedResult.standardizedWard; formFields.quanHuyenCu.value = standardizedResult.standardizedDistrict; formFields.tinhThanhCu.value = standardizedResult.standardizedProvince; formFields.diaChiCu.value = [oldAddressComponents.street_house, standardizedResult.standardizedWard, standardizedResult.standardizedDistrict, standardizedResult.standardizedProvince].filter(Boolean).join(', '); formFields.phuongXaMoi.value = newAddressComponents.newWard; formFields.tinhThanhMoi.value = newAddressComponents.newProvince; formFields.diaChiDayDuMoi.value = [oldAddressComponents.street_house, newAddressComponents.newWard, newAddressComponents.newDistrict, newAddressComponents.newProvince].filter(Boolean).join(', '); statusMessage.textContent = 'Phân tích và tra cứu địa chỉ thành công!'; }
        function formatNgay(e){return!e||8!==e.length?e:`${e.substring(0,2)}/${e.substring(2,4)}/${e.substring(4,8)}`}
        function parseVietnameseAddress(e){let t="",a="",o="",d="";const i=e.split(",").map(n=>n.trim());return i.length>=3?(d=i[i.length-1],o=i[i.length-2],a=i[i.length-3],t=i.slice(0,i.length-3).join(", ")):t=e,{street_house:t,ward:a,district:o,province:d}}
        function clearForm(){qrInput.value="",Object.values(formFields).forEach(e=>{e.value=""}),statusMessage.textContent=""}
        async function saveData(){if(!formFields.soCccd.value||!currentUserId)return void(statusMessage.textContent="Không có thông tin để lưu.");saveBtn.disabled=!0; document.getElementById('save-btn-text').textContent = 'Đang lưu'; document.getElementById('save-loader').classList.remove('hidden'); statusMessage.textContent="Đang lưu...";let e={};for(let t in formFields)e[t]=formFields[t].value;e.userId=currentUserId,e.createdAt=serverTimestamp();try{await addDoc(cccdCollectionRef,e); await sendToGoogleSheet(e)}catch(t){statusMessage.textContent=`Lỗi: ${t.message}`}finally{clearForm(); saveBtn.disabled=!1; document.getElementById('save-btn-text').textContent = '💾 Lưu Thông Tin'; document.getElementById('save-loader').classList.add('hidden');}}
        async function sendToGoogleSheet(e){if(!APPS_SCRIPT_URL)return;let t={action:"SAVE",payload:{...e,createdAt:(new Date).toLocaleString("vi-VN")}};try{let a=await fetch(APPS_SCRIPT_URL,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"text/plain;charset=utf-8"}}); let o = await a.json(); if(o.status !== 'success') { throw new Error(o.message); } statusMessage.textContent="Lưu thành công vào Firestore & Google Sheet!"}catch(a){statusMessage.textContent=`Lưu Firestore thành công, nhưng lỗi Google Sheet: ${a.message}`}}

        async function sendDeleteToGoogleSheet(e){if(!APPS_SCRIPT_URL||0===e.length)return;statusMessage.textContent="Đang đồng bộ xóa với Google Sheet...";let t={action:"DELETE",payload:{cccdIds:e}};try{let a=await fetch(APPS_SCRIPT_URL,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"text/plain;charset=utf-8"}});const o=await a.json();if("success"!==o.status)throw new Error(o.message);statusMessage.textContent="Xóa thành công và đã đồng bộ với Google Sheet!"}catch(a){statusMessage.textContent=`Xóa trên App thành công, nhưng lỗi đồng bộ Google Sheet: ${a.message}`}}
        function renderData(e){loadingSpinnerCards.classList.add("hidden");dataContainer.innerHTML="";"grid"===currentViewMode?renderGridView(e):renderListView(e);updateBulkActionToolbar();selectAllCheckbox.checked=currentRenderedIds.length>0&&currentRenderedIds.every(t=>selectedIds.includes(t));deleteAllBtn.disabled=0===allData.length}
        function renderGridView(e){dataContainer.className="flex-grow custom-scrollbar pr-2 overflow-y-auto grid grid-cols-1 xl:grid-cols-2 gap-3";currentRenderedIds=e.map(t=>t.id);e.forEach((t,a)=>{let o=document.createElement("div");o.className=`data-item bg-white dark:bg-gray-800 rounded-xl shadow-lg p-3 flex flex-col space-y-2 border-2 transition-all duration-300 ${selectedIds.includes(t.id)?"border-[rgb(var(--color-primary-500))]":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"}`,o.style.animationDelay=`${50*a}ms`;let d="Nữ"===t.gioiTinh?"bg-pink-500/10 dark:bg-pink-500/20 text-pink-500 dark:text-pink-400":"bg-green-500/10 dark:bg-green-500/20 text-green-600 dark:text-green-400",i="Nữ"===t.gioiTinh?"🙋‍♀️":"🙋‍♂️";o.innerHTML=`<div class="flex items-start justify-between"><div class="flex items-center space-x-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${d}">${i}</div><div><h3 class="font-bold text-md text-gray-900 dark:text-white">${t.hoVaTen||"Chưa có tên"}</h3><span class="text-xs text-gray-500 dark:text-gray-400">${t.ngaySinh||"N/A"}</span></div></div><input type="checkbox" class="h-5 w-5 text-[rgb(var(--color-primary-500))] bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-[rgb(var(--color-primary-500))] row-checkbox mt-1" data-id="${t.id}" ${selectedIds.includes(t.id)?"checked":""}></div><p class="text-gray-700 dark:text-gray-300 text-xs pt-2 border-t border-gray-200 dark:border-gray-700"><strong>CCCD:</strong> ${t.soCccd||"N/A"}</p><p class="text-gray-500 dark:text-gray-400 text-xs"><strong>Địa chỉ mới:</strong> ${t.diaChiDayDuMoi||"N/A"}</p><div class="flex justify-end space-x-2 mt-auto pt-2"><button class="summary-btn h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-purple-500 text-gray-600 dark:text-gray-300 hover:text-white flex items-center justify-center transition" data-id="${t.id}" title="Tạo tóm tắt bằng Gemini">✨</button><button class="edit-btn h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-indigo-500 text-gray-600 dark:text-gray-300 hover:text-white flex items-center justify-center transition" data-id="${t.id}" title="Chỉnh sửa">✏️</button><button class="delete-btn h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-red-500 text-gray-600 dark:text-gray-300 hover:text-white flex items-center justify-center transition" data-id="${t.id}" title="Xóa">🗑️</button></div>`,dataContainer.appendChild(o)})}
        function renderListView(e){dataContainer.className="flex-grow custom-scrollbar pr-2 overflow-y-auto flex flex-col gap-2";currentRenderedIds=e.map(t=>t.id);e.forEach((t,a)=>{let o=document.createElement("div");o.className=`data-item bg-white dark:bg-gray-800 rounded-lg p-2 flex items-center space-x-3 border-2 transition-all duration-300 ${selectedIds.includes(t.id)?"border-[rgb(var(--color-primary-500))]":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"}`,o.style.animationDelay=`${50*a}ms`;o.innerHTML=`<input type="checkbox" class="h-5 w-5 text-[rgb(var(--color-primary-500))] bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-[rgb(var(--color-primary-500))] row-checkbox flex-shrink-0" data-id="${t.id}" ${selectedIds.includes(t.id)?"checked":""}><div class="flex-1 min-w-0"><p class="font-semibold text-gray-800 dark:text-white truncate" title="${t.hoVaTen}">${t.hoVaTen}</p><p class="text-xs text-gray-500 dark:text-gray-400 truncate" title="${t.soCccd}">CCCD: ${t.soCccd}</p></div><div class="flex-1 min-w-0 hidden md:block"><p class="text-sm text-gray-600 dark:text-gray-300 truncate" title="${t.diaChiDayDuMoi||""}">${t.diaChiDayDuMoi||"N/A"}</p></div><div class="flex space-x-1 flex-shrink-0"><button class="summary-btn h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-purple-500 text-gray-600 dark:text-gray-300 hover:text-white flex items-center justify-center transition" data-id="${t.id}" title="Tạo tóm tắt bằng Gemini">✨</button><button class="edit-btn h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-indigo-500 text-gray-600 dark:text-gray-300 hover:text-white flex items-center justify-center transition" data-id="${t.id}" title="Chỉnh sửa">✏️</button><button class="delete-btn h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-red-500 text-gray-600 dark:text-gray-300 hover:text-white flex items-center justify-center transition" data-id="${t.id}" title="Xóa">🗑️</button></div>`,dataContainer.appendChild(o)})}
        function updateSummary(){totalCountEl.textContent=allData.length;maleCountEl.textContent=allData.filter(e=>"Nam"===e.gioiTinh).length;femaleCountEl.textContent=allData.filter(e=>"Nữ"===e.gioiTinh).length}function renderPagination(e,t,a){let o=0===a?0:(e-1)*ITEMS_PER_PAGE+1,d=Math.min(e*ITEMS_PER_PAGE,a);paginationControls.innerHTML=`<span class="text-gray-500 dark:text-gray-400">Hiển thị ${o}-${d} trên ${a}</span><div class="flex space-x-2"><button id="prev-page-btn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">Trước</button><span class="px-3 py-1 text-[rgb(var(--color-primary-500))] dark:text-[rgb(var(--color-primary-400))] font-semibold">Trang ${e} / ${t}</span><button id="next-page-btn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">Sau</button></div>`;let i=document.getElementById("prev-page-btn"),n=document.getElementById("next-page-btn");i.disabled=1===e,n.disabled=e===t||0===t,i.addEventListener("click",()=>{e>1&&(currentPage--,filterAndSortAndRender())}),n.addEventListener("click",()=>{e<t&&(currentPage++,filterAndSortAndRender())})}
        function filterAndSortAndRender(){let e=[...allData];let t=searchInput.value.toLowerCase().trim();t&&(e=e.filter(e=>(e.hoVaTen||"").toLowerCase().includes(t)||(e.soCccd||"").includes(t)),currentPage=1);e.sort((e,t)=>{let a=e.createdAt?.toDate()||0,o=t.createdAt?.toDate()||0;switch(sortSelect.value){case"oldest":return a-o;case"name_asc":return(e.hoVaTen||"").localeCompare(t.hoVaTen||"");case"name_desc":return(t.hoVaTen||"").localeCompare(e.hoVaTen||"");default:return o-a}});let a=e.length,o=Math.ceil(a/ITEMS_PER_PAGE)||1;currentPage=Math.min(currentPage,o);let d=e.slice((currentPage-1)*ITEMS_PER_PAGE,currentPage*ITEMS_PER_PAGE);renderData(d);renderPagination(currentPage,o,a);dataStatus.textContent=0===allData.length?"Không có dữ liệu.":""}
        function updateBulkActionToolbar(){let e=selectedIds.length;bulkActionToolbar.classList.toggle("hidden",0===e);e>0&&(selectionCount.textContent=`Đã chọn: ${e}`)}function openEditModal(e){let t=allData.find(t=>t.id===e);t&&(editDocIdInput.value=e,Object.keys(editFormFields).forEach(a=>{editFormFields[a].value=t[a]||""}),editModal.classList.remove("hidden"))}
        async function handleUpdateData(e){e.preventDefault();let t=editDocIdInput.value;if(!t)return;statusMessage.textContent="Đang cập nhật...";let a={};Object.keys(editFormFields).forEach(e=>{a[e]=editFormFields[e].value});let o=doc(db,cccdCollectionRef.path,t);try{await updateDoc(o,a);closeEditModal();statusMessage.textContent="Cập nhật thành công! ✅"}catch(d){statusMessage.textContent=`Cập nhật thất bại: ${d.message} ❌`}}

        function openDeleteConfirmModal(e){docIdsToDelete=Array.isArray(e)?e:[e];0!==docIdsToDelete.length&&(deleteConfirmText.textContent=`Hành động này sẽ xóa vĩnh viễn ${docIdsToDelete.length} mục. Bạn có chắc chắn không?`,deleteConfirmModal.classList.remove("hidden"))}function closeDeleteConfirmModal(){docIdsToDelete=[];deleteConfirmModal.classList.add("hidden")}async function executeDelete(){if(0===docIdsToDelete.length)return;statusMessage.textContent=`Đang xóa ${docIdsToDelete.length} mục...`;let e=writeBatch(db),t=[];docIdsToDelete.forEach(a=>{let o=allData.find(e=>e.id===a);o&&t.push(o.soCccd);e.delete(doc(db,cccdCollectionRef.path,a))});try{await e.commit();statusMessage.textContent=`Đã xóa ${docIdsToDelete.length} mục! ✅`;await sendDeleteToGoogleSheet(t)}catch(a){statusMessage.textContent=`Xóa thất bại: ${a.message} ❌`}finally{selectedIds=selectedIds.filter(e=>!docIdsToDelete.includes(e));closeDeleteConfirmModal()}}
        function stopScanning(){html5QrCode?.isScanning&&html5QrCode.stop().catch(()=>{});scannerContainer.classList.add("hidden")}function onScanSuccess(e){qrInput.value=e;stopScanning();analyzeQRCode()}
        function closeEditModal() { editModal.classList.add('hidden'); }
        function openSummaryModal() { summaryModal.classList.remove('hidden'); summaryContent.innerHTML = '<div class="loader mx-auto"></div>'; }
        function closeSummaryModal() { summaryModal.classList.add('hidden'); }
        async function handleGenerateSummary(docId) {const item = allData.find(d => d.id === docId);if (!item) {alert('Không tìm thấy dữ liệu.');return;}openSummaryModal();summaryContent.innerHTML = '<div class="loader mx-auto"></div><p class="text-center mt-2 text-sm text-gray-500">Gemini đang phân tích hồ sơ...</p>';try {await new Promise(resolve => setTimeout(resolve, 1500)); const geminiResponse = `Hồ sơ của ${item.hoVaTen}, giới tính ${item.gioiTinh}, sinh ngày ${item.ngaySinh}. Số CCCD là ${item.soCccd}, được cấp vào ngày ${item.ngayCap}. Hiện đang cư trú tại ${item.diaChiDayDuMoi}.`;summaryContent.innerHTML = `<p class="text-base leading-relaxed">${geminiResponse}</p>`;} catch (error) {summaryContent.innerHTML = '<p class="text-red-500">Xin lỗi, đã có lỗi xảy ra khi tạo tóm tắt.</p>';}}

        function parseCsvLine(line) { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const char = line[i]; if (char === '"' && (i === 0 || line[i-1] !== '\\')) { inQuotes = !inQuotes; } else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } else { current += char; } } result.push(current.trim()); return result.map(s => s.replace(/^"|"$/g, '')); }
        function handleFileImport(event, storageKey, statusElementId, isMapping = false) {
            const file = event.target.files[0], statusEl = document.getElementById(statusElementId);
            if (!file) { statusEl.textContent = "Chưa chọn tệp."; return; }
            statusEl.textContent = `Đang đọc ${file.name}...`;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                    lines.shift();
                    if (isMapping) {
                        const map = { provinces: {}, wards: {} };
                        lines.forEach(line => {
                            const columns = parseCsvLine(line);
                            if (columns.length < 4) return;
                            const [tinhMoi, gopTuTinhCu, phuongXaMoi, satNhapTuPhuongXa] = columns;
                            if (tinhMoi && gopTuTinhCu) gopTuTinhCu.split(',').map(s => s.trim()).filter(Boolean).forEach(oldProv => map.provinces[normalizeStr(oldProv)] = tinhMoi);
                            if (phuongXaMoi && satNhapTuPhuongXa) {
                                satNhapTuPhuongXa.split(',').map(s => s.trim()).filter(Boolean).forEach(oldWard => {
                                    const key = normalizeStr(oldWard);
                                    if (!map.wards[key]) map.wards[key] = [];
                                    map.wards[key].push({ newWard: phuongXaMoi, newProvince: tinhMoi });
                                });
                            }
                        });
                        localStorage.setItem(storageKey, JSON.stringify(map));
                    } else {
                        const data = lines.map(line => parseCsvLine(line));
                        localStorage.setItem(storageKey, JSON.stringify(data));
                    }
                    statusEl.textContent = `Đã cập nhật ${lines.length} dòng từ ${file.name}!`;
                    loadDataFromStorage();
                } catch (err) { statusEl.textContent = `Lỗi xử lý tệp: ${err.message}`; }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function downloadCsvTemplate(filename, headers) { const csvContent = "data:text/csv;charset=utf-8," + headers.join(","); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", filename); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        function loadDataFromStorage() { const savedDiachi = localStorage.getItem('userDiachiData'), savedSatnhap = localStorage.getItem('userSatnhapData'); if (savedDiachi) try { embeddedStandardizeData = JSON.parse(savedDiachi); } catch(e) { console.error("Lỗi đọc dữ liệu DSdiachi từ localStorage"); } if (savedSatnhap) try { embeddedMappingData = JSON.parse(savedSatnhap); } catch(e) { console.error("Lỗi đọc dữ liệu DSdiachisatnhap từ localStorage"); } document.getElementById('data-import-status').textContent = "Dữ liệu tra cứu đã được tải từ bộ nhớ trình duyệt."; }

        scanCameraBtn.addEventListener("click",()=>{scannerContainer.classList.remove("hidden");html5QrCode=new Html5Qrcode("reader");let e={fps:15,qrbox:{width:250,height:250},rememberLastUsedCamera:!0};html5QrCode.start({facingMode:"environment"},e,onScanSuccess).catch(()=>html5QrCode.start({},e,onScanSuccess).catch(()=>{statusMessage.textContent="Không thể khởi động camera.";stopScanning()}))});
        stopScanBtn.addEventListener("click",stopScanning),analyzeBtn.addEventListener("click",analyzeQRCode),saveBtn.addEventListener("click",saveData),clearFormBtn.addEventListener("click",clearForm),closeSummaryBtn.addEventListener("click",closeSummaryModal),qrInput.addEventListener("paste",()=>{setTimeout(analyzeQRCode,100)}),searchInput.addEventListener("input",()=>{currentPage=1,filterAndSortAndRender()}),sortSelect.addEventListener("change",()=>{currentPage=1,filterAndSortAndRender()}),editForm.addEventListener("submit",handleUpdateData),cancelEditBtn.addEventListener("click",closeEditModal),cancelDeleteBtn.addEventListener("click",closeDeleteConfirmModal),confirmDeleteBtn.addEventListener("click",executeDelete),deleteSelectedBtn.addEventListener("click",()=>openDeleteConfirmModal(selectedIds)),deleteAllBtn.addEventListener("click",()=>openDeleteConfirmModal(allData.map(e=>e.id)));
        document.getElementById('import-diachi').addEventListener('change', (e) => handleFileImport(e, 'userDiachiData', 'data-import-status'));
        document.getElementById('import-satnhap').addEventListener('change', (e) => handleFileImport(e, 'userSatnhapData', 'data-import-status', true));
        document.getElementById('export-diachi').addEventListener('click', () => downloadCsvTemplate('DSdiachi_mau.csv', ['TinhThanhPho', 'MaTP', 'QuanHuyen', 'MaQH', 'PhuongXa', 'MaPX', 'Cap']));
        document.getElementById('export-satnhap').addEventListener('click', () => downloadCsvTemplate('DSdiachisatnhap_mau.csv', ['TinhMoi', 'GopTuCacTinhCu', 'PhuongXaMoi', 'SatNhapTuCacPhuongXaTruoc']));
        dataContainer.addEventListener("click",e=>{let t=e.target,a=t.closest(".data-item");if(!a)return;let o=a.querySelector(".row-checkbox"),d=o.dataset.id;t.closest(".summary-btn")?handleGenerateSummary(d):t.closest(".edit-btn")?openEditModal(d):t.closest(".delete-btn")?openDeleteConfirmModal(d):o&&t!==o&&(o.checked=!o.checked,o.dispatchEvent(new Event("change",{bubbles:!0})))},!1),dataContainer.addEventListener("change",e=>{if(e.target.classList.contains("row-checkbox")){let t=e.target.dataset.id;e.target.checked?selectedIds.includes(t)||selectedIds.push(t):selectedIds=selectedIds.filter(e=>e!==t);filterAndSortAndRender()}}),selectAllCheckbox.addEventListener("change",e=>{e.target.checked?selectedIds=[...new Set([...selectedIds,...currentRenderedIds])]:selectedIds=selectedIds.filter(e=>!currentRenderedIds.includes(e));filterAndSortAndRender()});
        document.addEventListener("DOMContentLoaded",()=>{ loadDataFromStorage(); let themeToggle=document.getElementById("theme-toggle"), sun=document.getElementById("theme-icon-sun"), moon=document.getElementById("theme-icon-moon"); 
            // ===== FIX THEME: áp dụng và bật/tắt đúng =====
            function applyTheme(isDark) {
                document.documentElement.classList.toggle("dark", isDark);
                if (sun) sun.classList.toggle("hidden", isDark);
                if (moon) moon.classList.toggle("hidden", !isDark);
                localStorage.setItem("theme", isDark ? "dark" : "light");
            }
            const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const storedTheme = localStorage.getItem("theme");
            applyTheme(storedTheme ? storedTheme === "dark" : prefersDark);
            if (themeToggle) themeToggle.addEventListener("click", ()=>{ const isDark = document.documentElement.classList.contains("dark"); applyTheme(!isDark); });

            // view mode logic (giữ nguyên)
            function setViewMode(mode) {
                currentViewMode = mode;
                localStorage.setItem("viewMode", mode);
                viewModeToggle.querySelectorAll("button").forEach(t=>{
                    const a = t.dataset.view === mode;
                    t.classList.toggle("bg-gray-300", a);
                    t.classList.toggle("dark:bg-gray-600", a);
                    t.classList.toggle("text-[rgb(var(--color-primary-500))]", a);
                });
                filterAndSortAndRender();
            }
            viewModeToggle.querySelectorAll("button").forEach((btn) => { btn.addEventListener("click", () => setViewMode(btn.dataset.view)); });
            const storedView = localStorage.getItem("viewMode") || "grid"; setViewMode(storedView);

            // Firebase auth & snapshot (giữ nguyên logic gốc)
            onAuthStateChanged(auth, async (user) => {if (user) {currentUserId = user.uid;userInfo.textContent = `👤 ID: ${user.uid.substring(0, 12)}...`;loadingSpinnerCards.classList.remove("hidden");onSnapshot(query(cccdCollectionRef), (snapshot) => {allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));updateSummary();filterAndSortAndRender();loadingSpinnerCards.classList.add("hidden");}, (error) => {dataStatus.textContent = "Lỗi tải dữ liệu! ❌";loadingSpinnerCards.classList.add("hidden");});} else {userInfo.textContent = "Đang xác thực...";(async () => {try {if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {await signInWithCustomToken(auth, __initial_auth_token);} else {await signInAnonymously(auth);}} catch (error) {userInfo.textContent = "Lỗi xác thực! ⚠️";}})();}}); 
        });
    </script>
</body>
</html>
